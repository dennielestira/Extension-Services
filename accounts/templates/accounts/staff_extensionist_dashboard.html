{% extends 'accounts/home.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<style>
    body {
        background-color: #e8f5e9;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
    }

    /* Welcome Card */
    .dashboard-card {
        background: linear-gradient(135deg, #22b14c, #0d8331);
        color: white;
        border-radius: 15px;
        text-align: center;
        position: relative;
    }
    
    .dashboard-title {
        font-weight: bold;
        font-size: 2rem;
    }
    
    .dashboard-description {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    /* Help Button */
    .help-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #22b14c, #0d8331);
        color: white;
        border: none;
        font-size: 24px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 1000;
        transition: 0.3s;
    }
    
    .help-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(0,0,0,0.4);
    }

    /* Help Modal */
    .help-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 2000;
        overflow-y: auto;
    }

    .help-modal-content {
        background: white;
        max-width: 700px;
        margin: 50px auto;
        border-radius: 15px;
        padding: 30px;
        position: relative;
    }

    .help-close {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 28px;
        cursor: pointer;
        color: #666;
    }

    .help-section {
        margin-bottom: 25px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 10px;
        border-left: 4px solid #22b14c;
    }

    .help-section h4 {
        color: #1b5e20;
        margin-bottom: 10px;
    }

    /* Tooltip */
    .info-icon {
        display: inline-block;
        width: 20px;
        height: 20px;
        background: #ffffff;
        color: #1b5e20;
        border-radius: 50%;
        text-align: center;
        line-height: 20px;
        font-size: 14px;
        font-weight: bold;
        cursor: help;
        margin-left: 5px;
        position: relative;
    }

    .info-icon:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        white-space: nowrap;
        font-size: 12px;
        font-weight: normal;
        z-index: 1001;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .info-icon:hover::before {
        content: '';
        position: absolute;
        bottom: 115%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: #333;
    }

    /* First Time User Banner */
    .welcome-banner {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 20px;
        display: none;
    }

    .welcome-banner h5 {
        color: #856404;
        margin-bottom: 10px;
    }

    .welcome-banner button {
        background: #ffc107;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        margin-right: 10px;
    }

    /* Existing styles... */
    .main-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        min-height: 60vh;
        display: flex;
        flex-direction: column;
    }

    .upload-toggle-btn {
        background: #ffffff;
        color: #1b5e20;
        font-weight: bold;
        border-radius: 30px;
        padding: 10px 18px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        transition: 0.3s;
    }

    .upload-toggle-btn:hover {
        background: #c8e6c9;
    }

    .moa-upload-box {
        background: #ffffff;
        border: 1px solid #cfd8dc;
        border-radius: 12px;
        padding: 25px;
        max-width: 650px;
        margin: 20px auto;
        box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }

    .moa-upload-box input[type="text"],
    .moa-upload-box input[type="file"] {
        border-radius: 8px;
        padding: 10px;
    }

    .upload-btn {
        background: #2e7d32;
        color: white;
        padding: 10px 25px;
        border-radius: 30px;
        font-weight: bold;
        border: none;
        transition: 0.3s;
    }

    .upload-btn:hover {
        background: #1b5e20;
    }

    .pdf-logos {
        margin-top: 25px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 20px;
        justify-items: center;
    }

    .pdf-logos img {
        width: 90px;
        height: 90px;
        object-fit: contain;
        border-radius: 10px;
        padding: 8px;
        background: linear-gradient(135deg, #22b14c, #0d8331);
        box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        transition: 0.2s;
    }

    .pdf-logos img:hover {
        transform: scale(1.08);
    }

    .moa-title {
        margin-top: 8px;
        font-size: 14px;
        font-weight: 600;
    }

    .moa-controls {
        display: none;
        margin-top: 5px;
        font-size: 13px;
    }

    .toggle-edit-btn {
        background: #004d40;
        color: white;
        padding: 7px 15px;
        border-radius: 20px;
        font-size: 14px;
        margin-top: 15px;
        border: none;
        transition: 0.2s;
    }

    .toggle-edit-btn:hover {
        background: #00695c;
    }

    .content-wrapper, .main-card, .container-fluid {
        max-width: 1100px !important;
        margin: 0 auto !important;
        padding-left: 15px;
        padding-right: 15px;
    }

    .main-card .row {
        flex: 1;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
    }

    .main-card .col-lg-5,
    .main-card .col-lg-7 {
        display: flex;
        flex-direction: column;
        flex: 1 1 100%;
        min-height: 0;
    }

    .updates-box {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
        font-size: 0.9rem;
        line-height: 1.3;
        border-radius: 6px;
        background: #fff;
        max-height: 300px;
    }

    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
    }

    .status-box {
        padding: 8px;
        border-radius: 6px;
        min-height: 160px;
        display: flex;
        flex-direction: column;
    }

    .status-title {
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 0.9rem;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        padding-bottom: 4px;
    }

    .status-content {
        flex: 1;
        overflow-y: auto;
        font-size: 0.85rem;
        line-height: 1.3;
    }

    .updates-box::-webkit-scrollbar,
    .status-content::-webkit-scrollbar {
        width: 5px;
    }

    .updates-box::-webkit-scrollbar-thumb,
    .status-content::-webkit-scrollbar-thumb {
        background: #bbb;
        border-radius: 3px;
    }

    .status-pending { background-color: #fff8e1; }
    .status-recommended { background-color: #e8f5e9; }
    .status-approved { background-color: #e3f2fd; }
    .status-rejected { background-color: #ffebee; }
    .status-ongoing { background-color: #ede7f6; }
    .status-completion-reviewing { background-color: #f5f5f5; }
    .status-completion-recommended { background-color: #e8f5e9; }
    .status-completed { background-color: #f1f8e9; }

    .department-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 15px;
    }

    .department-box {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 12px;
        cursor: pointer;
        transition: 0.2s;
    }

    .department-box:hover {
        background: #f1f1f1;
    }

    .revision-card {
        display: none;
        margin-top: 10px;
        padding: 10px;
        border-radius: 8px;
        background: #fff8e1;
        border: 1px solid #ffcc80;
    }

    @media (max-width: 992px) {
        .dashboard-title { font-size: 1.6rem; }
        .dashboard-description { font-size: 1rem; }
    }

    @media (max-width: 768px) {
        .dashboard-title { font-size: 1.4rem; }
        .updates-box { max-height: 250px; }
        .help-btn {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
    }

    @media (max-width: 576px) {
        .dashboard-title { font-size: 1.2rem; }
        .dashboard-description { font-size: 0.95rem; }
        .status-grid { grid-template-columns: 1fr; }
        .updates-box { max-height: 200px; }
    }
</style>

<div class="container-fluid py-3">
    <!-- Welcome Banner for First Time Users -->
    <div class="welcome-banner" id="welcomeBanner">
        <h5>üëã Welcome to Your Dashboard!</h5>
        <p>New here? Click the buttons below to learn how to use this dashboard.</p>
        <button onclick="showHelpModal()">üìñ View Tutorial</button>
        <button onclick="dismissWelcome()">‚úì Got it!</button>
    </div>

    <div class="dashboard-card p-4 shadow-lg mb-5">
        <h1 class="dashboard-title mb-3">
            Welcome, <span class="role">{{ user.full_name }}</span> 
            <span style="cursor:pointer;" onclick="toggleMainButtons()" title="Click to show/hide controls">üëã</span>
            <span class="info-icon" data-tooltip="Click the wave emoji to show upload & edit controls">‚ÑπÔ∏è</span>
        </h1>

        <p class="dashboard-description">
            This is the Department Coordinator Dashboard where you can track and manage your assigned documents.
            <span class="info-icon" data-tooltip="Track document status, upload MOAs, and manage revisions">‚ÑπÔ∏è</span>
        </p>
        
        <!-- Upload toggle button -->
        <button class="upload-toggle-btn mt-3" onclick="toggleMOAUpload()" style="display:none;">
            üì§ Upload New MOA File
            <span class="info-icon" data-tooltip="Upload Memorandum of Agreement documents">‚ÑπÔ∏è</span>
        </button>

        <!-- Upload Box -->
        <div id="moa-upload-box" class="moa-upload-box" style="display:none;">
            <h4 style="color:#1b5e20;">Upload MOA Logo & PDF</h4>
            <form action="{% url 'upload_moa' %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <label class="mt-2">MOA Title:</label>
                <input type="text" name="title" class="form-control mb-3" required placeholder="Enter MOA title">
                <label>Logo Image:</label>
                <input type="file" name="logo" accept="image/*" class="form-control mb-3" required>
                <label>PDF File:</label>
                <input type="file" name="pdf_file" accept="application/pdf" class="form-control mb-4" required>
                <button class="upload-btn">Upload</button>
            </form>
        </div>

        <!-- Hide/Show Edit Delete -->
        <button class="toggle-edit-btn" onclick="toggleMOAControls()" style="display:none;">
            üõ† Show / Hide Edit & Delete
        </button>

        <!-- MOA Logos -->
        <div class="pdf-logos">
            {% if moa_list %}
                {% for moa in moa_list %}
                    <div class="text-center">
                        <a href="{{ moa.pdf_file.url }}" target="_blank" title="Click to view {{ moa.title }}">
                            <img src="{{ moa.logo.url }}" alt="{{ moa.title }}">
                        </a>
                        <div class="moa-title">{{ moa.title }}</div>
                        <div class="moa-controls">
                            <a href="{% url 'edit_moa' moa.id %}" class="text-primary">Edit</a> |
                            <a href="{% url 'delete_moa' moa.id %}" class="text-danger"
                               onclick="return confirm('Delete this MOA?')">Delete</a>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-light mt-3">No MOA files uploaded yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Main Card -->
    <div class="main-card">
        <div class="row g-3">
            <!-- Left -->
            <div class="col-lg-5">
                <div class="section-title">
                    <b>üìÑ All Document Updates</b>
                    <span class="info-icon" data-tooltip="Recent changes to documents in your department">‚ÑπÔ∏è</span>
                </div>
                <div class="updates-box">
                    {% if recent_updates %}
                        {% for doc in recent_updates %}
                            <p><strong>{{ doc.name }}</strong> became 
                                <em>{{ doc.get_status_display }}</em>
                                <span class="text-muted">{{ doc.status_updated_at|naturaltime }}</span>
                            </p>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No recent updates</p>
                    {% endif %}
                </div>
            </div>

            <!-- Right -->
            <div class="col-lg-7">
                <div class="status-grid">
                    {% for status in status_data %}
                        <div class="status-box 
                            {% with status.label|lower|slugify as slabel %}
                                status-{{ slabel }}
                            {% endwith %}
                        ">
                            <div class="status-title">
                                {{ status.label }}
                                <span class="info-icon" data-tooltip="Documents in {{ status.label }} status" style="font-size:10px;">‚ÑπÔ∏è</span>
                            </div>
                            <div class="status-content">
                                {% if status.documents %}
                                    {% for doc in status.documents %}
                                        <p><strong>{{ doc.name }}</strong>
                                            <span class="text-muted">{{ doc.status_updated_at|naturaltime }}</span>
                                        </p>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No documents</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Department Revision Section -->
<div class="mt-5">
    <h4>
        üìÇ Department Revisions
        <span class="info-icon" data-tooltip="Documents that need revision - click boxes to see details">‚ÑπÔ∏è</span>
    </h4>
    <div class="department-grid">
        {% for dept in departments %}
            <div class="department-box" onclick="toggleRevisionCard('{{ dept.id }}')">
                <div class="department-title">{{ dept.name }}</div>
                <small>{{ dept.documents_with_revisions|length }} file(s) need revision</small>

                <!-- Hidden Revision Card -->
                <div id="revision-card-{{ dept.id }}" class="revision-card">
                    <h6>‚ö† Revision Needed Files</h6>
                    <div class="revision-list">
                        {% if dept.documents_with_revisions %}
                            {% for doc in dept.documents_with_revisions %}
                                <div class="revision-doc mb-2">
                                    <strong>
                                        <a href="{% url 'view_document' doc.id %}">{{ doc.name }}</a>
                                    </strong>
                                    <ul class="mb-1">
                                        {% for file in doc.revision_files %}
                                            <li>{{ file }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No documents need revision</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Floating Help Button -->
<button class="help-btn" onclick="showHelpModal()" title="Need help?">‚ùì</button>

<!-- Help Modal -->
<div class="help-modal" id="helpModal" onclick="closeHelpModal(event)">
    <div class="help-modal-content" onclick="event.stopPropagation()">
        <span class="help-close" onclick="closeHelpModal()">&times;</span>
        <h2 style="color:#1b5e20; margin-bottom:20px;">üìö Dashboard Guide</h2>

        <div class="help-section">
            <h4>üéØ Getting Started</h4>
            <p><strong>Wave Emoji (üëã):</strong> Click the wave emoji next to your name to show/hide the upload and edit controls.</p>
            <p><strong>Info Icons (‚ÑπÔ∏è):</strong> Hover over any info icon to get quick tips about that feature.</p>
        </div>

        <div class="help-section">
            <h4>üì§ Uploading MOA Files</h4>
            <p>1. Click the wave emoji to reveal controls</p>
            <p>2. Click "Upload New MOA File" button</p>
            <p>3. Fill in the title, select logo image and PDF file</p>
            <p>4. Click "Upload" to save</p>
        </div>

        <div class="help-section">
            <h4>‚úèÔ∏è Editing & Deleting MOAs</h4>
            <p>1. Click the wave emoji to reveal controls</p>
            <p>2. Click "Show / Hide Edit & Delete" button</p>
            <p>3. Edit or Delete links will appear under each MOA logo</p>
        </div>

        <div class="help-section">
            <h4>üìä Understanding Document Status</h4>
            <p><strong>Pending:</strong> Awaiting review</p>
            <p><strong>Recommended:</strong> Approved by coordinator, awaiting staff review</p>
            <p><strong>Approved:</strong> Fully approved, ready for implementation</p>
            <p><strong>Ongoing:</strong> Currently in progress</p>
            <p><strong>Completed:</strong> Finished and archived</p>
        </div>

        <div class="help-section">
            <h4>üîÑ Revision Tracking</h4>
            <p>Click on any department box in the "Department Revisions" section to see which files need revision.</p>
            <p>Click the document name to view details and re-upload corrected files.</p>
        </div>

        <div class="help-section">
            <h4>üí° Pro Tips</h4>
            <p>‚Ä¢ Check the "All Document Updates" section daily for recent changes</p>
            <p>‚Ä¢ Use color-coded status boxes to quickly identify document states</p>
            <p>‚Ä¢ Hover over any ‚ÑπÔ∏è icon for context-specific help</p>
        </div>
    </div>
</div>

<!-- JS Toggle -->
<script>
// Check if first time visit
window.onload = function() {
    if (!localStorage.getItem('dashboardVisited')) {
        document.getElementById('welcomeBanner').style.display = 'block';
    }
};

function dismissWelcome() {
    document.getElementById('welcomeBanner').style.display = 'none';
    localStorage.setItem('dashboardVisited', 'true');
}

function showHelpModal() {
    document.getElementById('helpModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeHelpModal(event) {
    if (!event || event.target.id === 'helpModal') {
        document.getElementById('helpModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

function toggleRevisionCard(deptId) {
    const card = document.getElementById("revision-card-" + deptId);
    card.style.display = (card.style.display === "block") ? "none" : "block";
}

function toggleMainButtons() {
    const uploadBtn = document.querySelector('.upload-toggle-btn');
    const editBtn = document.querySelector('.toggle-edit-btn');

    [uploadBtn, editBtn].forEach(btn => {
        if (btn) {
            btn.style.display = (btn.style.display === 'none' || btn.style.display === '') 
                                ? 'inline-block' : 'none';
        }
    });
}

function toggleMOAUpload() {
    const box = document.getElementById("moa-upload-box");
    box.style.display = box.style.display === "none" ? "block" : "none";
}

function toggleMOAControls() {
    let controls = document.querySelectorAll(".moa-controls");
    controls.forEach(c => {
        c.style.display = (c.style.display === "none" || c.style.display === "") ? "block" : "none";
    });
}

// Keyboard shortcut: Press '?' to open help
document.addEventListener('keydown', function(e) {
    if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
        showHelpModal();
    }
    if (e.key === 'Escape') {
        closeHelpModal();
    }
});
</script>
{% endblock %}