{% extends 'accounts/home.html' %}
{% load tz %}


{% block title %}View Document{% endblock %}

{% block content %}

<style>
  .file-link {
    display: inline-block;
    max-width: 200px; /* adjust width for mobile */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: bottom;
  }
</style>

<div class="row" >
    <!-- Document Info Card -->
    <div class="col-md-4 d-flex">
        <div class="card card-small mb-4 h-100 w-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between mb-3">
                    <a href="{% url 'document_list' %}" class="btn btn-secondary">‚Üê Back</a>
<!-- {% if document.status == 'pending' %}
    {% if user.account_type == 'Department Coordinator' or user.account_type == 'Staff Extensionist' %}
        <form method="post" onsubmit="return confirm('Are you sure you want to delete this document?');">
            {% csrf_token %}
            <button type="submit" name="delete_document" class="btn btn-danger">üóëÔ∏è Delete</button>
        </form>
    {% endif %}
{% endif %} -->

                </div>

                <h5 class="card-title">{{ document.name }}</h5>
                <h6 class="card-subtitle mb-2 text-muted">
                    {% if document.uploaded_by %}
                        {{ document.uploaded_by.get_full_name }}
                    {% else %}
                        {{ document.uploaded_by_name }}
                    {% endif %}
                </h6>


                <p><strong>Department:</strong> {{ document.department }}</p>
                <p><strong>Status:</strong> {{ document.get_status_display }}</p>
{% if user.account_type == 'Campus Admin' and document.status != 'ongoing' and document.status != 'completed' and document.status != 'completion_processing' and document.status != 'completion_recommended' %}
    <a href="{% url 'approve_document' document.id %}" 
       class="btn btn-sm btn-success me-2 mb-2"
       onclick="return confirm('Are you sure you want to approve this without recommendation?');">
        ‚úÖ Approve
    </a>
{% endif %}

                {% if user.account_type == 'Campus Admin' and document.status == 'recommended' %}
                    <a href="{% url 'approve_document' document.id %}" class="btn btn-sm btn-success me-2 mb-2">‚úÖ Approve</a>
                    <a href="{% url 'need_revision_document' document.id %}" class="btn btn-sm btn-warning me-2 mb-2">‚Ü©Ô∏è Return for Revision</a>
                {% endif %}




                {% if user.account_type == 'Staff Extensionist' and document.status not in 'recommended ongoing completion_processing completion_recommended completion_rejected completed' %}
                    <a href="{% url 'recommend_document' document.id %}" class="btn btn-sm btn-primary">üì§ Recommend</a>
                {% endif %}

                {% if user.account_type == 'Staff Extensionist' and document.status not in 'recommended ongoing completion_recommended completion_rejected completed pending' %}
                    <a href="{% url 'recommend_completion' document.id %}" class="btn btn-sm btn-success">‚úÖ Recommend</a>
                    <a href="{% url 'reject_completion' document.id %}" class="btn btn-sm btn-danger">‚ùå Need Revisions</a>
                {% endif %}

                {% if user.account_type == 'Campus Admin' and document.status not in 'recommended ongoing completion_rejected completed pending' %}
                    <a href="{% url 'approve_completion' document.id %}" class="btn btn-sm btn-success">‚úÖ Approve</a>
                    <a href="{% url 'reject_completion' document.id %}" class="btn btn-sm btn-danger">‚ùå Need Revisions</a>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- Comments Card -->
<div class="col-md-6 d-flex">
    <div class="card card-small mb-4 w-100 h-100">
        <div class="card-body d-flex flex-column">
            <h5 class="card-title">Comments</h5>

            <!-- Scrollable comment list with fixed height -->
            <div class="mb-3 border p-2 rounded bg-light" style="flex: 1 1 auto; overflow-y: auto; max-height: 250px;">
                {% for comment in comments %}
                    <div class="mb-2 p-2 border-bottom">
                        <strong>{{ comment.user.get_full_name }}</strong><br>
                        <small class="text-muted">{{ comment.created_at|date:"M d, Y H:i" }}</small>
                        <p class="mb-0">{{ comment.text }}</p>
                    </div>
                {% empty %}
                    <p><em>No comments yet.</em></p>
                {% endfor %}
            </div>

            {% if can_comment and document.status != 'completed' %}
            {% if document.status != 'rejected' %}
                <form method="post">
                    {% csrf_token %}
                    {{ comment_form.as_p }}
                    <button type="submit" name="submit_comment" class="btn btn-primary btn-sm w-100">üíæ Add Comment</button>
                </form>
            {% endif %}

            {% endif %}
        </div>
    </div>
</div>

<!-- Initial Uploaded Files -->
<div class="card card-large mt-4">
  <div class="card-body">
    <h5 class="card-title">Initial Uploaded Files:</h5>

    {% if user.account_type == "Campus Admin" or user.account_type == "Staff Extensionist" %}
      <button class="btn btn-sm btn-secondary mb-3" id="toggle-initial-revision-btn">
        Show All Revision Buttons
      </button>
    {% endif %}

    <div class="file-container">
      {% for name, title, file, status in file_list %}
        {% if file %}
          <div class="file-item mb-3 p-3 border rounded">

            <!-- Make row wrap on small screens -->
            <div class="d-flex flex-wrap align-items-start gap-2">

              <!-- Title -->
              <strong class="me-1">{{ title }}:</strong>

              <!-- Filename -->
              <a href="{{ file.url }}" target="_blank" class="text-break">
                {{ file.name|cut:"documents/" }}
              </a>

              {% if status != "revision" %}

                <!-- Revision Button (your function still works) -->
                <form method="post" class="revision-form ms-2">
                  {% csrf_token %}
                  <input type="hidden" name="revision_doc" value="{{ name }}">
                  <button type="submit" name="mark_initial_revision"
                          class="btn btn-sm btn-warning">
                    Need Revision
                  </button>
                </form>

              {% else %}

                <span class="text-danger ms-2">‚ö† Needs Revision</span>

                <!-- üí¨ Comments Dropdown -->
                <div class="dropdown d-inline-block ms-2">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                          type="button" data-bs-toggle="dropdown">
                    üí¨ Comments
                  </button>

<div class="dropdown-menu p-3" style="min-width: 280px; max-width: 100%; max-height: 300px; overflow-y: auto;">


                    {% if user.account_type == "Campus Admin" or user.account_type == "Staff Extensionist" %}
                      <form method="post" enctype="multipart/form-data" class="mb-2">
                        {% csrf_token %}
                        <input type="hidden" name="day_id" value="{{ day.id }}">
                        <input type="hidden" name="slot_name" value="{{ name }}">

                        <textarea name="revision_comment" class="form-control mb-2"
                                  rows="4" placeholder="Add a comment..." required></textarea>

                        <input type="file" name="revision_image"
                               class="form-control form-control-sm mb-2" accept="image/*">

                        <button type="submit" name="submit_revision_comment"
                                class="btn btn-primary btn-sm w-100">
                          üí¨ Submit Comment
                        </button>
                      </form>
                    {% endif %}

                    <hr class="my-2">
                    <h6 class="fw-bold small mb-1">üóí Comments:</h6>

                    <div class="comment-list small" style="max-height:180px; overflow-y:auto;">
                      {% with has_comment=False %}
                        {% for feedback in revision_feedbacks %}
                          {% if feedback.slot_name == name %}
                            {% with has_comment=True %}
                              <div class="border-bottom py-1">
                                <strong>{{ feedback.user.get_full_name|default:feedback.user.username }}</strong>
                                <small class="text-muted ms-1">
                                  {{ feedback.created_at|date:"M d, Y h:i A" }}
                                </small>
                                <p class="mb-1">{{ feedback.comment }}</p>

                                {% if feedback.image %}
                                  <a href="{{ feedback.image.url }}" target="_blank">
                                    <img src="{{ feedback.image.url }}"
                                         class="img-thumbnail mt-1"
                                         style="max-width:150px;">
                                  </a>
                                {% endif %}
                              </div>
                            {% endwith %}
                          {% endif %}
                        {% endfor %}

                        {% if not has_comment %}
                          <p class="text-muted">No comments yet.</p>
                        {% endif %}
                      {% endwith %}
                    </div>

                  </div>
                </div>
                <!-- End Comments Dropdown -->

              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    {% if not document.Activity_Proposal and not document.Work_and_Financial_Plan and not document.Plan_of_Activities and not document.doc4 and not document.doc5 and not document.doc6 and not document.doc7 and not document.doc8 %}
      <p>No files uploaded yet.</p>
    {% endif %}

  </div>
</div>








    {% if user.account_type == 'Staff Extensionist' or user.account_type == 'Department Coordinator' %}
        <!-- Start Card for Editing Initial Uploads -->
        <div class="card card-large mt-4">
            <div class="card-body">
                <h5 class="card-title">Edit Initial Uploaded Files</h5>

                <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#editInitialUploadForm" aria-expanded="false" aria-controls="editInitialUploadForm">
                    ‚úèÔ∏è Edit Initial Uploaded Files
                </button>

                <div class="collapse mt-3" id="editInitialUploadForm">
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <div class="mb-3">
        <label for="initial_slot_choice" class="form-label">Select Initial Document Slot:</label>
        <select class="form-select" name="initial_slot_choice" id="initial_slot_choice" required>
            <option value="">-- Select Slot --</option>
            <option value="Activity_Proposal">Activity Proposal</option>
            <option value="Work_and_Financial_Plan">Work_and_Financial_Plan</option>
            <option value="Plan_of_Activities">Plan_of_Activities</option>
            <option value="doc4">Supporting Document 1</option>
            <option value="doc5">Supporting Document 2</option>
            <option value="doc6">Supporting Document 3</option>
            <option value="doc7">Supporting Document 4</option>
            <option value="doc8">Supporting Document 5</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Upload File:</label>
        <input type="file" name="initial_selected_file" class="form-control" required>
    </div>

    <div class="mt-4 d-flex gap-2">
        <button type="submit" name="submit_initial_upload" class="btn btn-primary">Upload Initial File</button>
    </div>
</form>

                </div>
            </div>
        </div>
        <!-- End Card for Editing Initial Uploads -->
    {% endif %}

{% if document.status != "pending" and document.status != "recommended" %}
<div class="card shadow-sm mt-3 border-0">
  <div class="card-body">

    <h5 class="card-title mb-3 fw-bold">üóì Days</h5>

    <!-- ‚úÖ Manage Days & Reports Section -->
    {% if user.account_type == 'Department Coordinator' or user.account_type == 'Extensionist' %}
      <button class="btn btn-sm btn-info mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#dayUploadForms">
        üì§ Manage Days & Reports
      </button>

      <div class="collapse" id="dayUploadForms">
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body bg-light rounded">

            <!-- ‚ûï Add Day -->
            <h6 class="fw-bold text-primary">‚ûï Add Day</h6>
            <form method="post" class="mb-3">
              {% csrf_token %}
              {{ day_form.as_p }}
              <button type="submit" name="add_day" class="btn btn-success btn-sm">Save Day</button>
            </form>

            <hr>

            <!-- ‚¨Ü Upload Training Report -->
            <h6 class="fw-bold text-primary">‚¨Ü Upload Training Report</h6>
<form method="post" enctype="multipart/form-data" class="mb-3">
  {% csrf_token %}
  <div class="mb-3">
    <label class="form-label fw-semibold">Select Day:</label>
    <select class="form-select" name="day_id" required>
      <option value="">-- Select Day --</option>
      {% for day in days %}
        {% if not day.training_reports.exists %}
          <option value="{{ day.id }}">{{ day.name }} ‚Äî {{ day.date }}</option>
        {% endif %}
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <label class="form-label fw-semibold">Title:</label>
    <input type="text" name="title" class="form-control" placeholder="Enter report title" required>
  </div>

  <div class="mb-3">
    <label class="form-label fw-semibold">Upload Training Report (.doc/.docx):</label>
    <input type="file" name="report_file" class="form-control" accept=".doc,.docx" required>
  </div>

  <button type="submit" name="upload_day_report" class="btn btn-primary btn-sm">Upload Report</button>
</form>


            <hr>

            <!-- üìé Upload Supporting Files -->
            <h6 class="fw-bold text-primary">üìé Upload Day Supporting Documents</h6>
            <form method="post" enctype="multipart/form-data" class="border rounded p-3 bg-white shadow-sm">
              {% csrf_token %}
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Select Day:</label>
                  <select class="form-select" name="day_id" required>
                    <option value="">-- Select Day --</option>
                    {% for day in days %}
                      <option value="{{ day.id }}">{{ day.name }} ‚Äî {{ day.date }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold">Select File Slot:</label>
                  <select class="form-select" name="file_slot" required>
                    <option value="">-- Select File Slot --</option>
                    <option value="doc1">Attendance Sheet</option>
                    <option value="doc2">Photo Documentation</option>
                    <option value="doc3">Program</option>
                    <option value="doc4">Supporting Document 1</option>
                    <option value="doc5">Supporting Document 2</option>
                  </select>
                </div>
              </div>

              <div class="mt-3">
                <label class="form-label fw-semibold">Choose File (.pdf/.doc/.docx):</label>
                <input type="file" name="selected_file" class="form-control" accept=".pdf,.doc,.docx" required>
              </div>

              <div class="mt-3 text-end">
                <button type="submit" name="upload_day_files" class="btn btn-primary btn-sm">
                  üìé Upload
                </button>
                <button type="reset" class="btn btn-outline-secondary btn-sm">Reset</button>
              </div>
            </form>

          </div>
        </div>
      </div>
    {% endif %}
    <!-- ‚úÖ End Manage Section -->

{% if days %}
  {% for day in days %}
    <div class="card mb-3 shadow-sm border-0">
      <div class="card-body">

        <!-- Day Header -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-2">
          <h6 class="fw-bold mb-2 mb-md-0">
            {{ day.name }} ‚Äî <small class="text-muted">{{ day.date }}</small>
          </h6>
          {% if user.account_type == 'Department Coordinator' or user.account_type == 'Extensionist' %}
            <div class="d-flex flex-wrap gap-1">
              <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#editDay{{ day.id }}">‚úè Edit</button>
              <form method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="day_id" value="{{ day.id }}">
                <button type="submit" name="delete_day" class="btn btn-sm btn-danger" onclick="return confirm('Delete this day?');">üóë Delete</button>
              </form>
            </div>
          {% endif %}
        </div>

        <!-- Edit Form -->
        <div class="collapse mb-3" id="editDay{{ day.id }}">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="day_id" value="{{ day.id }}">
            {{ day_form.as_p }}
            <button type="submit" name="edit_day" class="btn btn-primary btn-sm">Save</button>
          </form>
        </div>

        <!-- Training Reports -->
        <h6 class="fw-bold text-primary mb-2">üìò Training Reports</h6>
        <div class="border rounded p-2 bg-light">
          {% if day.training_reports.exists %}
            {% for report in day.training_reports.all %}
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-2">
                <div class="mb-1 mb-md-0">
                  {% if report.file %}
                    <small class="text-muted">({{ report.file.name|cut:"training_reports/" }})</small>
                  {% endif %}
                </div>
                <div class="d-flex flex-wrap gap-1">
                  <a href="{{ report.file.url }}" download class="btn btn-outline-success btn-sm">‚¨á Download</a>
                  {% if user.account_type == 'Department Coordinator' or user.account_type == 'Extensionist' %}
                    <button class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#editReport{{ report.id }}">‚úè</button>
                    <form method="post" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="report_id" value="{{ report.id }}">
                      <button type="submit" name="delete_report" class="btn btn-sm btn-danger" onclick="return confirm('Delete this report?');">üóë</button>
                    </form>
                  {% endif %}
                </div>
              </div>

              <small class="text-muted d-block mb-2">Uploaded by {{ report.uploaded_by.full_name|default:"Unknown" }}</small>

              <div class="collapse" id="editReport{{ report.id }}">
                <form method="post" enctype="multipart/form-data" class="border p-2 rounded bg-white mt-2">
                  {% csrf_token %}
                  <input type="hidden" name="report_id" value="{{ report.id }}">
                  {{ report_form.as_p }}
                  <button type="submit" name="edit_report" class="btn btn-primary btn-sm">Save Changes</button>
                </form>
              </div>
            {% endfor %}
          {% else %}
            <em class="text-muted">No training report uploaded yet.</em>
          {% endif %}
        </div>

<!-- Supporting Documents -->
<div class="mt-3">
  <h6 class="fw-bold text-primary mb-2">üìÅ Supporting Documents</h6>

  {% if day.day_files.exists %}
    {% with day.day_files.first as files %}
      <ul class="list-group list-group-flush">

        <!-- File 1 -->
        {% if files.doc1 %}
          <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <div class="mb-1 mb-md-0">
              üìé Attendance Sheet:
              <a href="{{ files.doc1.url }}" target="_blank" class="file-link">{{ files.doc1.name|cut:"day_files/" }}</a>
              {% if files.doc1_status == "revision" %}
                <span class="text-danger ms-2 fw-semibold">‚ö† Needs Revision</span>

                <div class="dropdown d-inline ms-0 ms-md-2 mt-1 mt-md-0">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    üí¨ Comments
                  </button>
                  <div class="dropdown-menu p-3" style="min-width: 280px; max-width: 100%; max-height: 300px; overflow-y: auto;">
                    {% if user.account_type == "Campus Admin" or user.account_type == "Staff Extensionist" %}

                      <form method="post" enctype="multipart/form-data" class="mb-2">
                        {% csrf_token %}
                        <input type="hidden" name="day_id" value="{{ day.id }}">
                        <input type="hidden" name="slot_name" value="day_doc1">
                        <textarea name="revision_comment" class="form-control mb-2" rows="2" placeholder="Add a comment..." required></textarea>
                        <input type="file" name="revision_image" class="form-control form-control-sm mb-2" accept="image/*">
                        <button type="submit" name="submit_day_revision_comment" class="btn btn-primary btn-sm w-100">üí¨ Submit Comment</button>
                      </form>
                    {% endif %}
                    {% with has_comment=False %}
                      {% for feedback in day.revision_feedbacks.all|dictsortreversed:"created_at" %}
                        {% if feedback.slot_name == "day_doc1" %}
                          {% with has_comment=True %}
                            <div class="border rounded p-2 mb-2">
                              <strong>{{ feedback.user.get_full_name|default:feedback.user.username }}</strong>
                              <small class="text-muted ms-1">{{ feedback.created_at|date:"M d, Y h:i A" }}</small>
                              <p class="mb-1">{{ feedback.comment }}</p>
                              {% if feedback.image %}
                                <a href="{{ feedback.image.url }}" target="_blank">
                                  <img src="{{ feedback.image.url }}" class="img-thumbnail mt-1" style="max-width:120px;">
                                </a>
                              {% endif %}
                            </div>
                          {% endwith %}
                        {% endif %}
                      {% endfor %}
                      {% if not has_comment %}
                        <p class="text-muted small">No comments yet.</p>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              {% endif %}
            </div>
          </li>
        {% endif %}

        <!-- File 2 -->
        {% if files.doc2 %}
          <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <div class="mb-1 mb-md-0">
              üìé Photo Documentation:
              <a href="{{ files.doc2.url }}" target="_blank" class="file-link">{{ files.doc2.name|cut:"day_files/" }}</a>
              {% if files.doc2_status == "revision" %}
                <span class="text-danger ms-2 fw-semibold">‚ö† Needs Revision</span>

                <div class="dropdown d-inline ms-0 ms-md-2 mt-1 mt-md-0">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    üí¨ Comments
                  </button>
                  <div class="dropdown-menu p-3" style="min-width: 280px; max-width: 100%; max-height: 300px; overflow-y: auto;">
                    {% if user.account_type == "Campus Admin" or user.account_type == "Staff Extensionist" %}

                      <form method="post" enctype="multipart/form-data" class="mb-2">
                        {% csrf_token %}
                        <input type="hidden" name="day_id" value="{{ day.id }}">
                        <input type="hidden" name="slot_name" value="day_doc2">
                        <textarea name="revision_comment" class="form-control mb-2" rows="2" placeholder="Add a comment..." required></textarea>
                        <input type="file" name="revision_image" class="form-control form-control-sm mb-2" accept="image/*">
                        <button type="submit" name="submit_day_revision_comment" class="btn btn-primary btn-sm w-100">üí¨ Submit Comment</button>
                      </form>
                    {% endif %}
                    {% with has_comment=False %}
                      {% for feedback in day.revision_feedbacks.all|dictsortreversed:"created_at" %}
                        {% if feedback.slot_name == "day_doc2" %}
                          {% with has_comment=True %}
                            <div class="border rounded p-2 mb-2">
                              <strong>{{ feedback.user.get_full_name|default:feedback.user.username }}</strong>
                              <small class="text-muted ms-1">{{ feedback.created_at|date:"M d, Y h:i A" }}</small>
                              <p class="mb-1">{{ feedback.comment }}</p>
                              {% if feedback.image %}
                                <a href="{{ feedback.image.url }}" target="_blank">
                                  <img src="{{ feedback.image.url }}" class="img-thumbnail mt-1" style="max-width:120px;">
                                </a>
                              {% endif %}
                            </div>
                          {% endwith %}
                        {% endif %}
                      {% endfor %}
                      {% if not has_comment %}
                        <p class="text-muted small">No comments yet.</p>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              {% endif %}
            </div>
          </li>
        {% endif %}

        <!-- File 3 -->
        {% if files.doc3 %}
          <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <div class="mb-1 mb-md-0">
              üìé Program:
              <a href="{{ files.doc3.url }}" target="_blank" class="file-link">{{ files.doc3.name|cut:"day_files/" }}</a>
              {% if files.doc3_status == "revision" %}
                <span class="text-danger ms-2 fw-semibold">‚ö† Needs Revision</span>

                <div class="dropdown d-inline ms-0 ms-md-2 mt-1 mt-md-0">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    üí¨ Comments
                  </button>
                  <div class="dropdown-menu p-3" style="min-width: 280px; max-width: 100%; max-height: 300px; overflow-y: auto;">
                    {% if user.account_type == "Campus Admin" or user.account_type == "Staff Extensionist" %}

                      <form method="post" enctype="multipart/form-data" class="mb-2">
                        {% csrf_token %}
                        <input type="hidden" name="day_id" value="{{ day.id }}">
                        <input type="hidden" name="slot_name" value="day_doc3">
                        <textarea name="revision_comment" class="form-control mb-2" rows="2" placeholder="Add a comment..." required></textarea>
                        <input type="file" name="revision_image" class="form-control form-control-sm mb-2" accept="image/*">
                        <button type="submit" name="submit_day_revision_comment" class="btn btn-primary btn-sm w-100">üí¨ Submit Comment</button>
                      </form>
                    {% endif %}
                    {% with has_comment=False %}
                      {% for feedback in day.revision_feedbacks.all|dictsortreversed:"created_at" %}
                        {% if feedback.slot_name == "day_doc3" %}
                          {% with has_comment=True %}
                            <div class="border rounded p-2 mb-2">
                              <strong>{{ feedback.user.get_full_name|default:feedback.user.username }}</strong>
                              <small class="text-muted ms-1">{{ feedback.created_at|date:"M d, Y h:i A" }}</small>
                              <p class="mb-1">{{ feedback.comment }}</p>
                              {% if feedback.image %}
                                <a href="{{ feedback.image.url }}" target="_blank">
                                  <img src="{{ feedback.image.url }}" class="img-thumbnail mt-1" style="max-width:120px;">
                                </a>
                              {% endif %}
                            </div>
                          {% endwith %}
                        {% endif %}
                      {% endfor %}
                      {% if not has_comment %}
                        <p class="text-muted small">No comments yet.</p>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              {% endif %}
            </div>
          </li>
        {% endif %}

        <!-- File 4 -->
        {% if files.doc4 %}
          <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <div class="mb-1 mb-md-0">
              üìé Supporting Document 1:
              <a href="{{ files.doc4.url }}" target="_blank" class="file-link">{{ files.doc4.name|cut:"day_files/" }}</a>
              {% if files.doc4_status == "revision" %}
                <span class="text-danger ms-2 fw-semibold">‚ö† Needs Revision</span>

                <div class="dropdown d-inline ms-0 ms-md-2 mt-1 mt-md-0">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    üí¨ Comments
                  </button>
                  <div class="dropdown-menu p-3" style="min-width: 280px; max-width: 100%; max-height: 300px; overflow-y: auto;">
                    {% if user.account_type == "Campus Admin" or user.account_type == "Staff Extensionist" %}

                      <form method="post" enctype="multipart/form-data" class="mb-2">
                        {% csrf_token %}
                        <input type="hidden" name="day_id" value="{{ day.id }}">
                        <input type="hidden" name="slot_name" value="day_doc4">
                        <textarea name="revision_comment" class="form-control mb-2" rows="2" placeholder="Add a comment..." required></textarea>
                        <input type="file" name="revision_image" class="form-control form-control-sm mb-2" accept="image/*">
                        <button type="submit" name="submit_day_revision_comment" class="btn btn-primary btn-sm w-100">üí¨ Submit Comment</button>
                      </form>
                    {% endif %}
                    {% with has_comment=False %}
                      {% for feedback in day.revision_feedbacks.all|dictsortreversed:"created_at" %}
                        {% if feedback.slot_name == "day_doc4" %}
                          {% with has_comment=True %}
                            <div class="border rounded p-2 mb-2">
                              <strong>{{ feedback.user.get_full_name|default:feedback.user.username }}</strong>
                              <small class="text-muted ms-1">{{ feedback.created_at|date:"M d, Y h:i A" }}</small>
                              <p class="mb-1">{{ feedback.comment }}</p>
                              {% if feedback.image %}
                                <a href="{{ feedback.image.url }}" target="_blank">
                                  <img src="{{ feedback.image.url }}" class="img-thumbnail mt-1" style="max-width:120px;">
                                </a>
                              {% endif %}
                            </div>
                          {% endwith %}
                        {% endif %}
                      {% endfor %}
                      {% if not has_comment %}
                        <p class="text-muted small">No comments yet.</p>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              {% endif %}
            </div>
          </li>
        {% endif %}

        <!-- File 5 -->
        {% if files.doc5 %}
          <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
            <div class="mb-1 mb-md-0">
              üìé Supporting Document 2:
              <a href="{{ files.doc5.url }}" target="_blank" class="file-link">{{ files.doc5.name|cut:"day_files/" }}</a>
              {% if files.doc5_status == "revision" %}
                <span class="text-danger ms-2 fw-semibold">‚ö† Needs Revision</span>

                <div class="dropdown d-inline ms-0 ms-md-2 mt-1 mt-md-0">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    üí¨ Comments
                  </button>
                  <div class="dropdown-menu p-3" style="min-width: 280px; max-width: 100%; max-height: 300px; overflow-y: auto;">
                    {% if user.account_type == "Campus Admin" or user.account_type == "Staff Extensionist" %}

                      <form method="post" enctype="multipart/form-data" class="mb-2">
                        {% csrf_token %}
                        <input type="hidden" name="day_id" value="{{ day.id }}">
                        <input type="hidden" name="slot_name" value="day_doc5">
                        <textarea name="revision_comment" class="form-control mb-2" rows="2" placeholder="Add a comment..." required></textarea>
                        <input type="file" name="revision_image" class="form-control form-control-sm mb-2" accept="image/*">
                        <button type="submit" name="submit_day_revision_comment" class="btn btn-primary btn-sm w-100">üí¨ Submit Comment</button>
                      </form>
                    {% endif %}
                    {% with has_comment=False %}
                      {% for feedback in day.revision_feedbacks.all|dictsortreversed:"created_at" %}
                        {% if feedback.slot_name == "day_doc5" %}
                          {% with has_comment=True %}
                            <div class="border rounded p-2 mb-2">
                              <strong>{{ feedback.user.get_full_name|default:feedback.user.username }}</strong>
                              <small class="text-muted ms-1">{{ feedback.created_at|date:"M d, Y h:i A" }}</small>
                              <p class="mb-1">{{ feedback.comment }}</p>
                              {% if feedback.image %}
                                <a href="{{ feedback.image.url }}" target="_blank">
                                  <img src="{{ feedback.image.url }}" class="img-thumbnail mt-1" style="max-width:120px;">
                                </a>
                              {% endif %}
                            </div>
                          {% endwith %}
                        {% endif %}
                      {% endfor %}
                      {% if not has_comment %}
                        <p class="text-muted small">No comments yet.</p>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              {% endif %}
            </div>
          </li>
        {% endif %}

      </ul>

      <!-- Revision Controls -->
      {% if user.account_type == "Campus Admin" or user.account_type == "Staff Extensionist" %}

        <div class="mt-3">
          <button class="btn btn-sm btn-secondary mb-2 toggle-day-revision-btn">Show Revision Controls</button>
          <div class="day-revision-controls" style="display:none;">
            <form method="post" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="day_id" value="{{ day.id }}">
              <select name="revision_doc" class="form-select form-select-sm d-inline w-auto">
                <option value="">Select File Slot</option>
                <option value="day_doc1">Attendance sheet</option>
                <option value="day_doc2">Photo Documentation</option>
                <option value="day_doc3">Program</option>
                <option value="day_doc4">Supporting Document 1</option>
                <option value="day_doc5">Supporting Document 2</option>
              </select>
              <button type="submit" name="make_day_revision" class="btn btn-sm btn-warning">üö© Mark for Revision</button>
            </form>
          </div>
        </div>
      {% endif %}

    {% endwith %}
  {% else %}
    <p class="text-muted">No supporting documents uploaded yet.</p>
  {% endif %}
</div>



          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">No days have been added yet.</p>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Completion Uploaded Files -->
<div class="card card-large mt-4">
  {% if existing_completion %}
    <div class="card-body">
      <h5 class="card-title">Uploaded Completion Documents:</h5>

      {% if user.account_type == "Campus Admin" or user.account_type == "Staff Extensionist" %}
        <button class="btn btn-sm btn-secondary mb-3" id="toggle-completion-revision-btn">
          Show All Revision Buttons
        </button>
      {% endif %}

      <div class="file-container">
        {% for name, title, file, status in completion_file_list %}
          {% if file %}
            <div class="file-item mb-3 p-3 border rounded">

              <!-- Make layout wrap properly on smaller screens -->
              <div class="d-flex flex-wrap align-items-start gap-2">

                <!-- Title -->
                <strong class="me-1">{{ title }}:</strong>

                <!-- Filename (auto-wrap long names) -->
                <a href="{{ file.url }}" target="_blank" class="text-break">
                  {{ file.name|cut:"documents/completion/" }}
                </a>

                {% if status != "revision" %}

                  {% if user.account_type == "Campus Admin" or user.account_type == "Staff Extensionist" %}
                    <!-- SAME FUNCTION, DO NOT TOUCH -->
                    <form method="post" class="revision-form ms-2">
                      {% csrf_token %}
                      <input type="hidden" name="revision_doc" value="{{ name }}">
                      <button type="submit" name="mark_revision_completion" class="btn btn-sm btn-warning">
                        Need Revision
                      </button>
                    </form>
                  {% endif %}

                {% else %}

                  <!-- Status -->
                  <span class="text-danger ms-2">‚ö† Needs Revision</span>

                  <!-- üí¨ Comments Dropdown -->
                  <div class="dropdown d-inline-block ms-2">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                      üí¨ Comments
                    </button>

                    <!-- Make dropdown responsive -->
                    <div class="dropdown-menu p-3" style="min-width: 280px; max-width: 100%; max-height: 300px; overflow-y: auto;">

                      {% if user.account_type == "Campus Admin" or user.account_type == "Staff Extensionist" %}
                        <form method="post" enctype="multipart/form-data" class="mb-2">
                          {% csrf_token %}
                          <input type="hidden" name="completion_ocument" value="{{ name }}">

                          <textarea name="revision_comment" class="form-control mb-2"
                                    rows="4" placeholder="Add a comment..." required></textarea>

                          <input type="file" name="revision_image"
                                 class="form-control form-control-sm mb-2"
                                 accept="image/*">

                          <button type="submit" name="submit_completion_revision_comment"
                                  class="btn btn-primary btn-sm w-100">
                            üí¨ Submit Comment
                          </button>
                        </form>
                      {% endif %}

                      <hr class="my-2">
                      <h6 class="fw-bold small mb-1">üóí Comments:</h6>

                      <div class="comment-list small" style="max-height:180px; overflow-y:auto;">
                        {% with has_comment=False %}
                          {% for feedback in completion_feedbacks %}
                            {% if feedback.slot_name == name %}
                              {% with has_comment=True %}
                                <div class="border-bottom py-1">
                                  <strong>{{ feedback.user.get_full_name|default:feedback.user.username }}</strong>
                                  <small class="text-muted ms-1">
                                    {{ feedback.created_at|date:"M d, Y h:i A" }}
                                  </small>

                                  <p class="mb-1">{{ feedback.comment }}</p>

                                  {% if feedback.image %}
                                    <a href="{{ feedback.image.url }}" target="_blank">
                                      <img src="{{ feedback.image.url }}"
                                           class="img-thumbnail mt-1"
                                           style="max-width:150px;">
                                    </a>
                                  {% endif %}
                                </div>
                              {% endwith %}
                            {% endif %}
                          {% endfor %}
                          {% if not has_comment %}
                            <p class="text-muted">No comments yet.</p>
                          {% endif %}
                        {% endwith %}
                      </div>

                    </div>
                  </div>
                  <!-- End Comments -->

                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>

      {% if completion_file_list|length == 0 %}
        <p>No completion files uploaded yet.</p>
      {% endif %}

    </div>
  {% endif %}
</div>



{% if document.status == 'ongoing' and can_upload_completion %}
<div class="card card-small mt-3 shadow-sm">
    <div class="card-body p-3">
        <h5 class="card-title mb-3">üìÇ Upload or Edit Completion Document</h5>

        <button class="btn btn-sm btn-info mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#completionUploadForm" aria-expanded="false" aria-controls="completionUploadForm">
            üì§ Manage Completion Documents
        </button>

        <div class="collapse mt-3" id="completionUploadForm">
            <div class="card card-large">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-muted">Upload or update completion-related documents for this project.</h6>

                    {% if existing_completion %}
                        <div class="alert alert-info py-2">
                            Re-uploading a file in a slot will <strong>replace</strong> the existing one.
                        </div>
                    {% endif %}

<!-- COMPLETION UPLOAD FORM -->
<form method="post" enctype="multipart/form-data" id="completionForm">
    {% csrf_token %}

    <div class="mb-3">
        <label for="completion_slot_choice" class="form-label fw-bold">Select Completion Document Slot:</label>
        <select class="form-select" name="completion_slot_choice" id="completion_slot_choice" required>
            <option value="">-- Select Slot --</option>
            <option value="completion_doc1">Approved Letter Request</option>
            <option value="completion_doc2">Accomplished / Evaluation Form</option>
            <option value="completion_doc3">Authority to Go</option>
            <option value="completion_doc4">Supporting Document 1</option>
            <option value="completion_doc5">Supporting Document 2</option>
            <option value="completion_doc6">Supporting Document 3</option>
            <option value="completion_doc7">Supporting Document 4</option>
            <option value="completion_doc8">Supporting Document 5</option>
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">Upload File:</label>
        <input type="file" name="selected_file" class="form-control" required>
    </div>

    <!-- LEAVE ONLY SAVE INSIDE -->
    <button type="submit" name="save_completion_changes" class="btn btn-secondary">
        üíæ Save Changes
    </button>
</form>



                </div>
            </div>
        </div>
    </div>
</div>

<!--  SUBMIT COMPLETION ‚Äî OUTSIDE FORM -->
{% if user.account_type == 'Department Coordinator' %}
<button class="btn btn-primary mt-3" onclick="submitCompletionFinal()">
    üìé Submit Completion File (Finalize)
</button>
{% endif %}
{% endif %}

<!-- JS Toggle -->
<!-- JS Toggle -->
<script>
function confirmCompletion() {
    return confirm("Are you sure you want to submit this completion file?\nPlease make sure all required documents are complete.");
}

document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.getElementById("toggle-revision-btn");
    const forms = document.querySelectorAll(".revision-form");
    let hidden = true; // start hidden

    // Hide forms on load
    forms.forEach(f => f.style.display = "none");

    toggleBtn.addEventListener("click", function () {
        hidden = !hidden;
        forms.forEach(f => f.style.display = hidden ? "none" : "block");
        toggleBtn.textContent = hidden ? "Show All Revision Buttons" : "Hide All Revision Buttons";
    });
});
document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.getElementById("toggle-initial-revision-btn");
    if (!toggleBtn) return;

    const card = toggleBtn.closest(".card"); // only forms inside this card
    const forms = card.querySelectorAll(".revision-form");

    let hidden = false; // start visible

    toggleBtn.addEventListener("click", function () {
        hidden = !hidden;
        forms.forEach(f => f.style.display = hidden ? "none" : "inline-block");
        toggleBtn.textContent = hidden ? "Show All Revision Buttons" : "Hide All Revision Buttons";
    });
});

document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.getElementById("toggle-completion-revision-btn");
    if (!toggleBtn) return;

    const card = toggleBtn.closest(".card"); // only forms inside this card
    const forms = card.querySelectorAll(".revision-form");

    let hidden = false; // start visible

    toggleBtn.addEventListener("click", function () {
        hidden = !hidden;
        forms.forEach(f => f.style.display = hidden ? "none" : "inline-block");
        toggleBtn.textContent = hidden ? "Show All Revision Buttons" : "Hide All Revision Buttons";
    });
});

function confirmFileReplacement(form) {
  const daySelect = form.querySelector('select[name="day_id"]');
  const slotSelect = form.querySelector('select[name="file_slot"]');
  const existingFile = form.dataset.existingFile;

  if (existingFile && existingFile !== "") {
    return confirm(`This slot already has "${existingFile}". Are you sure you want to replace it?`);
  }
  return true;
}

function updateExistingFileName(dayId) {
  const slotSelect = document.getElementById(`fileSlotSelect${dayId}`);
  const fileInfo = document.getElementById(`existingFileInfo${dayId}`);
  const selectedSlot = slotSelect.value;
  const files = {
    {% with day.day_files.first as f %}
      doc1: "{{ f.doc1.name|cut:'day_files/'|default:'' }}",
      doc2: "{{ f.doc2.name|cut:'day_files/'|default:'' }}",
      doc3: "{{ f.doc3.name|cut:'day_files/'|default:'' }}",
      doc4: "{{ f.doc4.name|cut:'day_files/'|default:'' }}",
      doc5: "{{ f.doc5.name|cut:'day_files/'|default:'' }}"
    {% endwith %}
  };

  const existing = files[selectedSlot] || "";
  if (existing) {
    fileInfo.textContent = `Currently uploaded: ${existing}`;
    slotSelect.form.dataset.existingFile = existing;
  } else {
    fileInfo.textContent = "No file currently uploaded in this slot.";
    slotSelect.form.dataset.existingFile = "";
  }
}
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.toggle-day-revision-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const controls = this.nextElementSibling;
        if (controls.style.display === 'none') {
          controls.style.display = 'block';
          this.textContent = 'Hide Revision Controls';
        } else {
          controls.style.display = 'none';
          this.textContent = 'Show Revision Controls';
        }
      });
    });
  });
function submitCompletionFinal() {
    let form = document.getElementById("completionForm");

    if (!confirm("Submit completion and update status?")) return;

    const hidden = document.createElement("input");
    hidden.type = "hidden";
    hidden.name = "upload_completion";
    hidden.value = "1";
    form.appendChild(hidden);

    form.submit();
}
</script>



{% endblock %}
