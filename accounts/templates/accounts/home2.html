{% extends 'accounts/main.html' %}
{% load static %}

{% block title %}Objectives & Media Gallery{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/objectives.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="{% static 'css/Designing.css' %}"> 

<!-- Toggle Button for Sidebar
<button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
    ‚ò∞
</button> -->

<!-- BACOOREx Sidebar -->
<aside class="bacoorex-sidebar" id="bacoorexSidebar">
    <!-- Logos Row 1 -->
    <div class="sidebar-logos">
        <img src="{% static 'image/logo.png' %}" alt="Logo 1">
        <img src="{% static 'image/logo2.png' %}" alt="Logo 2">
        <img src="{% static 'image/c.png' %}" alt="Logo 3">
                <img src="{% static 'image/d.png' %}" alt="Logo 4">
        <img src="{% static 'image/e.png' %}" alt="Logo 5">
        <img src="{% static 'image/f.png' %}" alt="Logo 6">
    </div>
    <!-- Title -->
    <div class="sidebar-title">
        <h1>BACOOREx</h1>
    </div>
    <div class="sidebar-divider"></div>
    <p class="sidebar-subtitle">
        Bridging Academe with the Community through Operative and Outcome-based Research and Extension
    </p>

    <div class="sidebar-divider"></div>

    <p class="sidebar-description">
        A community extension program of Cavite State University - Bacoor City Campus in partnership with the City Government of Bacoor
    </p>
</aside>

<!-- Media Gallery Header -->
<section id="media-gallery">
    <div class="gallery-header">
        <h2>Cavite State University Extension Services - Bacoor Campus</h2>

    </div>
</section>


<section id="albums">
    <h3 class="section-title">Photo Albums</h3>

    {% if user.is_authenticated %}
    <div class="upload-buttons" style="margin-bottom: 15px;">
        <!-- Button to upload a new album -->
        <a href="{% url 'album_upload' %}" class="btn btn-success">+ Upload Album</a>
    </div>
    {% endif %}

    <div class="album-grid">
        {% for album in albums %}
        <div class="album-card" data-album-id="{{ album.id }}">
            <!-- Use cover_url property -->
            <img src="{{ album.cover_url }}"
                 alt="{{ album.title }}"
                 data-album-title="{{ album.title }}">
            <div class="overlay">
                <p>{{ album.title }}</p>
            </div>
            <!-- hidden photos for modal -->
            <div class="album-photos" style="display:none;">
                {% for photo in album.photos.all %}
                    <img src="{{ photo.image_url }}"
                        alt="{{ photo.caption|default:album.title }}"
                        data-photo-id="{{ photo.id }}"
                        data-description="{{ photo.caption|default:album.description|default:'No description' }}">
                {% endfor %}
            </div>

        </div>
        {% empty %}
        <p>No albums available.</p>
        {% endfor %}
    </div>
    <!-- Album Pagination -->
<div class="pagination">
    {% if albums.has_previous %}
        <a href="?album_page={{ albums.previous_page_number }}#albums" class="page-btn">¬´ Prev</a>
    {% endif %}

    <span class="page-info">Page {{ albums.number }} of {{ albums.paginator.num_pages }}</span>

    {% if albums.has_next %}
        <a href="?album_page={{ albums.next_page_number }}#albums" class="page-btn">Next ¬ª</a>
    {% endif %}
</div>


</section>

<div id="albumModal" class="album-modal" aria-hidden="true">
  <div class="album-modal-inner">
    <span class="album-modal-close" onclick="closeAlbumModal()">&times;</span>

    <!-- album navigation outside the box -->
    

    <div class="album-modal-body">
      <!-- LEFT: image + photo navigation -->
        <!-- LEFT: image + photo navigation -->
<div class="album-left">
  <div class="album-image-wrapper" style="position:relative;">
      <img id="modalAlbumImage" class="album-modal-image" src="" alt="Album photo">

      <!-- photo navigation -->
      <button class="photo-nav photo-prev" onclick="changeAlbumPhoto(-1)" aria-label="Previous photo">&#10094;</button>
      <button class="photo-nav photo-next" onclick="changeAlbumPhoto(1)" aria-label="Next photo">&#10095;</button>

<!-- photo edit/delete buttons overlay -->
{% if user.is_authenticated %}
<div class="photo-actions"
     style="position:absolute; bottom:10px; left:10px; z-index:20; display:flex; gap:6px;">
      <a id="modalEditPhotoBtn"
         href="#"
         class="btn btn-warning btn-sm"
         data-template-url="{% url 'photo_edit' 0 %}">
         ‚úé Edit
      </a>

      <!-- Delete Photo -->
      <form id="modalDeletePhotoForm" method="POST" style="display:inline;"
            data-template-url="{% url 'delete_photo' 0 %}" action="#">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger"
                  onclick="return confirm('Delete this photo?');">
              üóë Delete
          </button>
      </form>
</div>
{% endif %}

  </div>

  <div id="modalPhotoCounter" class="photo-counter"></div>
</div>

<!-- RIGHT: title / description / upload -->
<div class="album-right">
  <h3 id="modalAlbumCaption"></h3>
  <p id="modalAlbumDescription"></p>

<div style="margin-top:8px;">
  {% if user.is_authenticated %}
  <div class="dropdown">
    <!-- Dropdown Toggle Button -->
    <button class="btn btn-secondary dropdown-toggle" type="button" id="albumActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
      Album Actions
    </button>

    <!-- Dropdown Menu -->
    <ul class="dropdown-menu" aria-labelledby="albumActionsDropdown">
      <li>
        <a class="dropdown-item text-white" 
           style="background-color:#ffc107;" 
           id="modalEditAlbumBtn"
           data-template-url="{% url 'album_edit' 0 %}">
           ‚úé Edit Album
        </a>
      </li>
      <li>
        <form id="modalDeleteAlbumForm" method="POST" style="margin:0;" 
              data-template-url="{% url 'delete_album' 0 %}" action="#">
          {% csrf_token %}
          <button type="submit" class="dropdown-item text-white" 
                  style="background-color:#dc3545;"
                  onclick="return confirm('Delete this album?');">
            üóë Delete Album
          </button>
        </form>
      </li>
      <li>
        <a class="dropdown-item text-white" 
           style="background-color:#0d6efd;" 
           id="modalUploadPhotoBtn"
           data-template-url="{% url 'photo_upload' 0 %}">
           ‚¨Ü Upload Photo
        </a>
      </li>
    </ul>
  </div>
  {% endif %}
</div>

</div>
    </div>
    <div class="album-modal-nav">
    <span class="album-prev" onclick="changeAlbum(-1)" title="Previous album">&#10094; Album</span>
    <span class="album-next" onclick="changeAlbum(1)" title="Next album">Album &#10095;</span>
</div>

    <!-- album navigation outside the box -->
    
  </div>
</div>






<!-- Videos Section 
<section id="videos">
    <h3 class="section-title">Videos</h3>

    {% comment %}
    Show Upload button ONLY if user is Campus Admin OR Staff Extensionist
    AND only show if uploaded videos are less than 2
    {% endcomment %}
    
    {% if user.account_type == 'Campus Admin' or user.account_type == 'Staff Extensionist' %}
        {% if user.is_authenticated %}
            {% if total_videos < 2 %}
                <a href="{% url 'media_upload' %}" class="upload-btn">+ Upload New</a>
            {% else %}
                <p class="limit-warning" style="color:red; font-size:14px;">
                    Maximum of 2 videos reached. Delete one to upload again.
                </p>
            {% endif %}
        {% endif %}
    {% endif %}

    <div class="media-grid">
        {% for video in video_page_obj %}
        <div class="media-card">
            <video 
                controls preload="metadata" loading="lazy"
                style="width:100%; border-radius:8px; max-height:250px; cursor:pointer;"
                data-title="{{ video.title }}"
                data-description="{{ video.description|default_if_none:'No description available.' }}"
                data-src="{{ video.file.url }}">
                <source src="{{ video.file.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <p>{{ video.title }}</p>

            {% if user.account_type == 'Campus Admin' or user.account_type == 'Staff Extensionist' %}
                {% if user.is_authenticated %}
                <div class="action-links d-flex justify-content-center gap-2">
                    <a href="{% url 'media_edit' video.pk %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-edit"></i> Edit
                    </a>

                    <form method="post" action="{% url 'media_delete' video.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm"
                            onclick="return confirm('Are you sure you want to delete {{ video.title }}?');">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </form>
                </div>
                {% endif %}
            {% endif %}
        </div>
        {% empty %}
            <p class="empty-msg">No videos uploaded.</p>
        {% endfor %}
    </div>


Video Pagination 
<div class="pagination">
    {% if video_page_obj.has_previous %}
        <a href="?video_page={{ video_page_obj.previous_page_number }}#videos" class="page-btn">‚Üê Previous</a>
    {% endif %}

    <span class="page-info">
        Page {{ video_page_obj.number }} of {{ video_page_obj.paginator.num_pages }}
    </span>

    {% if video_page_obj.has_next %}
        <a href="?video_page={{ video_page_obj.next_page_number }}#videos" class="page-btn">Next ‚Üí</a>
    {% endif %}
</div>-->

</section>


<!-- Video Modal -->
<div id="videoModal" class="album-modal" aria-hidden="true" style="display:none;">
  <div class="album-modal-inner">
    <span class="album-modal-close" onclick="closeVideoModal()">&times;</span>

    <div class="album-modal-body">
      <!-- LEFT: Video -->
      <div class="album-left">
        <video id="modalVideo" controls style="width:100%; max-height:70vh; background:#000;">
          <source src="" type="video/mp4">
          Your browser does not support HTML video.
        </video>
      </div>

      <!-- RIGHT: Title and Description -->
      <div class="album-right">
        <h3 id="videoCaption"></h3>
        <p id="videoDescription"></p>
      </div>
    </div>

    <!-- navigation 
    <span class="album-modal-nav album-prev" onclick="changeVideo(-1)">&#10094; Prev</span>
    <span class="album-modal-nav album-next" onclick="changeVideo(1)">Next &#10095;</span>-->
  </div>
</div>

<section class="image-showcase" id="image-showcase">

{% if user.account_type == 'Campus Admin' or user.account_type == 'Staff Extensionist' %}

    <!-- Upload Form -->
    {% if user.is_authenticated %}
    <form action="{% url 'upload_image' %}" method="post" enctype="multipart/form-data" style="margin-bottom:20px;">
        {% csrf_token %}
        <input type="file" name="image" accept="image/*" required>
        <button type="submit" class="btn btn-success">Upload</button>

    </form>
    {% endif %}
{% endif %}
    <!-- Images -->
<div id="image-list" class="showcase-container">
    {% for img in showcase_images %}
    <div class="showcase-item" data-id="{{ img.id }}" style="position:relative;">
        <img src="{{ img.image.url }}" alt="Showcase Image">
        {% if user.account_type == 'Campus Admin' or user.account_type == 'Staff Extensionist' %}

        {% if user.is_authenticated %}
        <div style="position:absolute; top:10px; right:10px; display:flex; gap:5px; flex-direction:column;">
            
            <!-- Move Up / Down -->
            <form method="post" action="{% url 'move_showcase_image' img.id 'up' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-secondary">‚Üë</button>
            </form>
            <form method="post" action="{% url 'move_showcase_image' img.id 'down' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-secondary">‚Üì</button>
            </form>

            <!-- Edit Image -->
            <form method="post" action="{% url 'edit_showcase_image' img.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <label class="btn btn-sm btn-warning" style="margin:0; cursor:pointer;">
                    ‚úé Edit
                    <input type="file" name="image" accept="image/*" onchange="this.form.submit();" style="display:none;">
                </label>
            </form>

            <!-- Delete -->
            <a href="{% url 'delete_image' img.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Delete this image?')">‚úï</a>
        </div>
        {% endif %}
        {% endif %}
    </div>
    {% empty %}
    <p class="empty-msg">No showcase photos yet.</p>
    {% endfor %}
</div>




<div class="fb-section text-center">
  <a href="https://www.facebook.com/BACOOREx" target="_blank">
    <img src="{% static 'image/image.png' %}" alt="Facebook" class="fb-logo">
  </a>
  <div class="fb-info mt-2">
    <strong>CvSU Bacoor Campus Extension Services</strong><br>
    <a href="https://www.facebook.com/BACOOREx" target="_blank">
      https://www.facebook.com/groups/409413203281698/
    </a>
  </div>
</div>

<div class="project text-center">
  <p><strong>Project 1:</strong><br>
  <em>Empowering Community through Holistic Development Program</em><br>
  FB Page: <a href="https://www.facebook.com/DASextensionservices" target="_blank">
  https://www.facebook.com/DASextensionservices</a></p>

  <p><strong>Project 2:</strong><br>
  <em>Computer Literacy and System Support Extension Services (CLASSES) </em><br>
  FB Page: <a href="https://www.facebook.com/_DCSBacoor: CLASSES Extension Program" target="_blank">
  https://www.facebook.com/_DCSBacoor: CLASSES Extension Program</a></p>

  <p><strong>Project 3:</strong><br>
  <em>Community Resiliency and Intervention Mentoring (CRIM)</em><br>
  FB Page: <a href="https://www.facebook.com/Cvsu Bacoor Criminology Research and Extension" target="_blank">
  https://www.facebook.com/Cvsu Bacoor Criminology Research and Extension</a></p>

  <p><strong>Project 4:</strong><br>
  <em>Kaagapay sa Kabuhayan tungo sa Kaunlaran (KKK)</em><br>
  FB Page: <a href="https://www.facebook.com/Cavite State University Bacoor City Campus: DMS Extension Services" target="_blank">
  https://www.facebook.com/Cavite State University Bacoor City Campus: DMS Extension Services</a></p>

  <p><strong>Project 5:</strong><br>
  <em>Teaching for Enrichment and Development (TED)</em><br>
  FB Page: <a href="https://www.facebook.com/DTE Extension Page" target="_blank">
  https://www.facebook.com/DTE Extension Page</a></p>
</div>
</section>

<script>
/* ========================== */
/*      Global Variables      */
/* ========================== */
let videos = [];
let videoIndex = 0;

let albums = [];
let currentAlbumIndex = 0;
let currentPhotoIndex = 0;

/* ========================== */
/*   DOMContentLoaded Init    */
/* ========================== */
document.addEventListener("DOMContentLoaded", () => {

    /* ----- Initialize Videos ----- */
    videos = Array.from(document.querySelectorAll(".media-card video"));
    videos.forEach((vid, idx) => {
        vid.addEventListener("click", e => {
            e.stopPropagation();
            openVideoModal(idx);
        });
        const card = vid.closest(".media-card");
        if (card) {
            card.addEventListener("click", e => { if(e.target !== vid) openVideoModal(idx); });
        }
    });

    /* ----- Initialize Albums ----- */
    initAlbums();

    /* ----- Keyboard Navigation ----- */
    document.addEventListener("keydown", e => {
        const videoModalVisible = getComputedStyle(document.getElementById('videoModal')).display === 'flex';
        const albumModalVisible = getComputedStyle(document.getElementById('albumModal')).display === 'flex';

        if(videoModalVisible){
            if(e.key === "ArrowLeft") changeVideo(-1);
            if(e.key === "ArrowRight") changeVideo(1);
            if(e.key === "Escape") closeVideoModal();
        }

        if(albumModalVisible){
            if(e.key === "ArrowLeft") changeAlbumPhoto(-1);
            if(e.key === "ArrowRight") changeAlbumPhoto(1);
            if(e.key === "Escape") closeAlbumModal();
        }
    });

    /* ----- Click Outside Modals ----- */
    const videoModal = document.getElementById("videoModal");
    if(videoModal) videoModal.addEventListener('click', e => { if(e.target === videoModal) closeVideoModal(); });

    const albumModal = document.getElementById("albumModal");
    if(albumModal) albumModal.addEventListener('click', e => { if(e.target === albumModal) closeAlbumModal(); });

});

/* ========================== */
/*       Video Functions      */
/* ========================== */
function openVideoModal(idx) {
    videoIndex = idx;
    loadVideoLazy();
    document.getElementById("videoModal").style.display = "flex";
}

function closeVideoModal() {
    const modal = document.getElementById("videoModal");
    const vid = document.getElementById("modalVideo");
    try { vid.pause(); vid.removeAttribute("src"); vid.load(); } catch(e){}
    modal.style.display = "none";
}

function changeVideo(step){
    videoIndex = (videoIndex + step + videos.length) % videos.length;
    loadVideoLazy();
}

function loadVideoLazy(){
    const vid = videos[videoIndex];
    const modalVid = document.getElementById("modalVideo");

    // Only load src if needed
    if(modalVid.src !== vid.dataset.src) {
        modalVid.src = vid.dataset.src || vid.src;
    }

    modalVid.pause();
    modalVid.load();
    modalVid.play().catch(()=>{});

    document.getElementById("videoCaption").innerText = vid.dataset.title || "Video";
    document.getElementById("videoDescription").innerText = vid.dataset.description || "No description available.";
}

/* ========================== */
/*       Album Functions      */
/* ========================== */
function initAlbums(){
    const albumCards = document.querySelectorAll(".album-card");
    
    albums = Array.from(albumCards).map((card, index) => {
        const albumId = card.dataset.albumId;
        const coverImg = card.querySelector("img");
        const albumTitle = coverImg ? coverImg.dataset.albumTitle : "Untitled Album";
        const photos = Array.from(card.querySelectorAll(".album-photos img"));

        // IMPORTANT: Don't modify the src attributes, just ensure dataset.src exists
        photos.forEach(p => { 
            if(!p.dataset.src) {
                // If dataset.src doesn't exist, copy from src attribute
                p.dataset.src = p.getAttribute('src') || p.src;
            }
        });
        
        // Also store cover src
        if(coverImg && !coverImg.dataset.src) {
            coverImg.dataset.src = coverImg.getAttribute('src') || coverImg.src;
        }
        
        console.log(`Album ${index}: ID=${albumId}, Title=${albumTitle}, Photos=${photos.length}`);
        
        return { id: albumId, title: albumTitle, cover: coverImg, photos: photos, index: index };
    });

    // Make the ENTIRE album card clickable, not just the image
    albumCards.forEach((card, idx) => {
        card.style.cursor = "pointer"; // Show pointer cursor
        
        // Remove any existing listeners by cloning the node
        const newCard = card.cloneNode(true);
        card.parentNode.replaceChild(newCard, card);
        
        // Add fresh click listener
        newCard.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log(`Clicked album card at index: ${idx}`);
            openAlbumModal(idx);
        });
    });
    
    console.log("Initialized albums:", albums.length);
}

function openAlbumModal(albumIndex, photoIndex=0){
    console.log("Opening album modal - Album Index:", albumIndex, "Photo Index:", photoIndex);
    
    // Validate album index
    if(albumIndex < 0 || albumIndex >= albums.length) {
        console.error("Invalid album index:", albumIndex);
        return;
    }
    
    // Set indices FIRST before any operations
    currentAlbumIndex = albumIndex;
    currentPhotoIndex = photoIndex;

    const modal = document.getElementById("albumModal");
    const modalImg = document.getElementById("modalAlbumImage");
    
    // Show modal immediately
    modal.style.display = "flex";
    
    // Load content
    loadPhotoLazy();
}

function loadPhotoLazy(){
    const album = albums[currentAlbumIndex];
    if(!album) {
        console.error("Album not found at index:", currentAlbumIndex);
        return;
    }

    console.log("Loading album:", album.title, "Photos count:", album.photos.length);
    
    // Use photos if available, otherwise fall back to cover
    const photoList = album.photos.length > 0 ? album.photos : [album.cover];
    
    // Ensure photoIndex is within bounds
    if(currentPhotoIndex < 0) currentPhotoIndex = 0;
    if(currentPhotoIndex >= photoList.length) currentPhotoIndex = 0;
    
    const photo = photoList[currentPhotoIndex];
    
    if(!photo) {
        console.error("Photo not found at index:", currentPhotoIndex);
        return;
    }
    
    const modalImg = document.getElementById("modalAlbumImage");

    // Get source - try multiple methods to ensure we get the URL
    let newSrc = photo.dataset.src || photo.getAttribute('src') || photo.src;
    
    console.log("Loading photo source:", newSrc); // Debug log
    
    if (newSrc && newSrc !== '') {
        modalImg.src = newSrc;
        modalImg.alt = photo.alt || photo.dataset.description || album.title;
    } else {
        console.error("No valid source found for photo at index:", currentPhotoIndex);

        // Try to show album cover as fallback
        if (album.cover && (album.cover.dataset?.src || album.cover.src)) {
            const coverSrc =
                album.cover.dataset?.src ||
                album.cover.src;

            modalImg.src = coverSrc;
            modalImg.alt = album.title + " (Cover Image)";
        } else {
            // Absolute final fallback (prevents modal from breaking)
            modalImg.removeAttribute("src");
            modalImg.alt = "Image not available";
        }
    }


    // Update text content
    const caption = document.getElementById("modalAlbumCaption");
    const description = document.getElementById("modalAlbumDescription");
    const counter = document.getElementById("modalPhotoCounter");
    
    if(caption) caption.innerText = album.title || "Untitled Album";
    if(description) {
        const photoDesc = photo.dataset.description || photo.getAttribute('data-description') || "No description";
        description.innerText = photoDesc;
    }
    if(counter) {
        counter.innerText = photoList.length > 1 ? `Photo ${currentPhotoIndex+1} of ${photoList.length}` : "Cover";
    }

    // Update Album Buttons
    const editAlbumBtn = document.getElementById("modalEditAlbumBtn");
    if(editAlbumBtn && album.id) {
        editAlbumBtn.href = editAlbumBtn.dataset.templateUrl.replace("0", album.id);
    }
    
    const deleteAlbumForm = document.getElementById("modalDeleteAlbumForm");
    if(deleteAlbumForm && album.id) {
        deleteAlbumForm.action = deleteAlbumForm.dataset.templateUrl.replace("0", album.id);
    }
    
    const uploadPhotoBtn = document.getElementById("modalUploadPhotoBtn");
    if(uploadPhotoBtn && album.id) {
        uploadPhotoBtn.href = uploadPhotoBtn.dataset.templateUrl.replace("0", album.id);
    }

    // Update Photo Buttons
    const editPhotoBtn = document.getElementById("modalEditPhotoBtn");
    const deletePhotoForm = document.getElementById("modalDeletePhotoForm");
    
    const photoId = photo.dataset.photoId || photo.getAttribute('data-photo-id');
    
    if(photoId){
        if(editPhotoBtn) { 
            editPhotoBtn.style.display = "inline-block"; 
            editPhotoBtn.href = editPhotoBtn.dataset.templateUrl.replace("0", photoId);
        }
        if(deletePhotoForm) { 
            deletePhotoForm.style.display = "inline-block"; 
            deletePhotoForm.action = deletePhotoForm.dataset.templateUrl.replace("0", photoId);
        }
    } else {
        if(editPhotoBtn) editPhotoBtn.style.display = "none";
        if(deletePhotoForm) deletePhotoForm.style.display = "none";
    }
}

function changeAlbumPhoto(step){
    const album = albums[currentAlbumIndex];
    const photoList = album.photos.length > 0 ? album.photos : [album.cover];
    currentPhotoIndex = (currentPhotoIndex + step + photoList.length) % photoList.length;
    console.log("Changed to photo index:", currentPhotoIndex);
    loadPhotoLazy();
}

function changeAlbum(step){
    currentAlbumIndex = (currentAlbumIndex + step + albums.length) % albums.length;
    currentPhotoIndex = 0;
    console.log("Changed to album index:", currentAlbumIndex);
    loadPhotoLazy();
}

function closeAlbumModal(){
    const modal = document.getElementById("albumModal");
    const modalImg = document.getElementById("modalAlbumImage");
    
    console.log("Closing album modal");
    
    // Hide modal first
    modal.style.display = "none";
    
    // Clear image
    modalImg.src = '';
    modalImg.alt = '';
    
    // Clear text content
    const caption = document.getElementById("modalAlbumCaption");
    const description = document.getElementById("modalAlbumDescription");
    const counter = document.getElementById("modalPhotoCounter");
    
    if(caption) caption.innerText = '';
    if(description) description.innerText = '';
    if(counter) counter.innerText = '';
}

/* ========================== */
/*        Pagination AJAX      */
/* ========================== */
function loadAlbums(event, page){
    event.preventDefault();
    fetch(`?album_page=${page}`)
        .then(resp => resp.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html,'text/html');
            document.querySelector('.album-grid').innerHTML = doc.querySelector('.album-grid').innerHTML;
            document.querySelector('#albums .pagination').innerHTML = doc.querySelector('#albums .pagination').innerHTML;
            document.querySelector('#albums').scrollIntoView({behavior:'smooth'});
            initAlbums();
        });
}
// Make showcase images clickable
document.querySelectorAll('.showcase-item img').forEach(img => {
    img.addEventListener('click', function(e){
        const parent = this.parentElement;

        // Toggle clicked class
        if(parent.classList.contains('clicked')){
            parent.classList.remove('clicked');
        } else {
            // Remove clicked from any other image
            document.querySelectorAll('.showcase-item.clicked').forEach(el => el.classList.remove('clicked'));
            parent.classList.add('clicked');
        }
    });
});


function loadVideos(event, page){
    event.preventDefault();
    fetch(`?video_page=${page}`)
        .then(resp => resp.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html,'text/html');
            document.querySelector('.media-grid').innerHTML = doc.querySelector('.media-grid').innerHTML;
            document.querySelector('#videos .pagination').innerHTML = doc.querySelector('#videos .pagination').innerHTML;
            document.querySelector('#videos').scrollIntoView({behavior:'smooth'});
            videos = Array.from(document.querySelectorAll(".media-card video"));
        });
}
//======= DRAG & DROP SORTING =======
new Sortable(document.getElementById("image-list"), {
    animation: 180,
    onEnd: function () {
        let order = [];
        document.querySelectorAll(".image-card").forEach(card=>{
            order.push(card.dataset.id);
        });

        // Save to DB using AJAX POST
        fetch("{% url 'reorder_images' %}",{
            method: "POST",
            headers: {'X-CSRFToken': '{{ csrf_token }}','Content-Type':'application/x-www-form-urlencoded'},
            body: new URLSearchParams({ 'order[]': order })
        })
    }
});
document.querySelectorAll('[id^="edit-file-"]').forEach(input => {
    input.addEventListener('change', function() {
        const submitBtn = document.getElementById(`edit-submit-${this.id.split('-')[2]}`);
        if(this.files.length > 0) submitBtn.click();
    });
});
/* ========================== */
/*   BACOOREx Sidebar Toggle  */
/* ========================== */
const sidebarToggle = document.getElementById('sidebarToggle');
const bacoorexSidebar = document.getElementById('bacoorexSidebar');

if (sidebarToggle && bacoorexSidebar) {
    // Create overlay element
    const overlay = document.createElement('div');
    overlay.className = 'sidebar-overlay';
    document.body.appendChild(overlay);

    // Toggle function
    function toggleSidebar() {
        const isOpen = bacoorexSidebar.classList.contains('show');
        
        if (isOpen) {
            bacoorexSidebar.classList.remove('show');
            overlay.classList.remove('show');
            sidebarToggle.innerHTML = '‚ò∞';
            sidebarToggle.setAttribute('aria-label', 'Open Sidebar');
        } else {
            bacoorexSidebar.classList.add('show');
            overlay.classList.add('show');
            sidebarToggle.innerHTML = '‚úï';
            sidebarToggle.setAttribute('aria-label', 'Close Sidebar');
        }
    }

    // Toggle button click
    sidebarToggle.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleSidebar();
    });

    // Overlay click (close sidebar)
    overlay.addEventListener('click', function() {
        if (bacoorexSidebar.classList.contains('show')) {
            toggleSidebar();
        }
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
        if (window.innerWidth <= 992) {
            if (!bacoorexSidebar.contains(event.target) && 
                !sidebarToggle.contains(event.target) &&
                bacoorexSidebar.classList.contains('show')) {
                toggleSidebar();
            }
        }
    });

    // Handle window resize
    window.addEventListener('resize', function() {
        if (window.innerWidth > 992) {
            bacoorexSidebar.classList.remove('show');
            overlay.classList.remove('show');
            sidebarToggle.innerHTML = '‚ò∞';
        }
    });
}
</script>

{% endblock %}
